
from run_exp_test import run_inference_for_optimization

def compute_mem(x):
    return (x[0] * 75900 + x[1] * 844800 + x[2] * 844800 + x[3] * 844800 + x[8] * 281600 + x[9] * 281600 + x[
        10] * 281600 + x[14] * 2094400 + 8800 * 16)/8/1024/1024

def compute_mem_3(x):
    return (x[0] * 75900 + x[1] * 844800 + x[2] * 844800 +  x[6] * 281600 + x[7] * 281600 + x[10] * 2094400 + 8800 * 16)/8/1024/1024

def compute_mem_6(x):
    return (x[0] * 75900 + x[1] * 844800 + x[2] * 844800 + x[3] * 844800 +x[4] * 844800 + x[5] * 844800 + x[12] * 281600 + x[13] * 281600 + x[
        14] * 281600+ x[15] * 281600 + x[
        16] * 281600 + x[22] * 2094400 + 8800 * 16)/8/1024/1024


exp_sru_4=[

 [16,16,16,16,16,  16,16,16,16,16, 16,16,16,16,16, 16,16,16,16,16,   16,16],
 [8,8,8,8, 8,8,8,8, 8,8,8,  8,8,8,  8,8],
 [4,4,4,4, 4,4,4,4,   4,4,4, 4,4,4, 4,4],
 [2,2,2,2, 2,2,2,2, 2,2,2,  2,2,2, 2,4],
 [16,2,2,2,    16,16,16,16,  16,2,2,  16,16,16, 16,16],#M1
 [16,2,2,2,   16,16,16,16,    16,2,2,  16,16,16, 4,4],#M2
 [16,2,2,2,   16,4,4,4,       16,2,2,   16,16,16,  16,16],#M3
 [16,2,2,2,   16,16,16,16,  16,2,2,   16,4,4,  16,16],#M4
 [16,2,2,2,   16,16,16,16,  2,2,2,    16,16,16, 2,16],#M5
 [2,2,2,2,   16,16,16,16,  2,2,2,    16,16,16, 2,16],#M6
 [8,4,4,4,    8,4,4,4, 4,4,4,    4,4,4, 4,4],#M7
 [8,2,2,2,   8,4,4,4, 4,4,4,     4,4,4, 4,4],#M8
 [8,4,4,4,     8,4,4,4, 4,2,2,    4,4,4, 4,4],#M9
 [4,2,2,2,   8,4,4,4,   4,4,4,   4,4,4, 4,4],#M10
 [8,4,4,4,    8,4,4,4,  2,2,2,    4,4,4, 4,4],#M11
 [8,4,4,4,   8,4,4,4,    4,2,2,   4,4,4, 2,4],#M12
 [8,2,2,2,    8,4,4,4,   2,2,2,   4,4,4, 4,4],#M13
 [8,2,2,2,    8,4,4,4,    4,2,2,  4,4,4, 2,4],#M14
 [4,2,2,2,    4,4,4,4,   4,2,2,   4,4,4, 2,4],#M15
]

exp_sru_6=[

 [16,16,16,16,16,16,  16,16,16,16,16,16, 16,16,16,16,16, 16,16,16,16,16,   16,16],
 [8,8,8,8,8,8, 8,8,8,8,8,8, 8,8,8,8,8,  8,8,8,8,8,  8,8],
 [4,4,4,4,4,4, 4,4,4,4,4,4,   4,4,4,4,4,  4,4,4,4,4, 4,4],
 [2,2,2,2,2,2, 2,2,2,2,2,2, 2,2,2,2,2,  2,2,2,2,2, 2,4],
 [16,2,2,2,2,2,    16,16,16,16,16,16,  16,2,2,2,2,  16,16,16,16,16, 16,16],#M1
 [16,2,2,2,2,2,   16,16,16,16,16,16,    16,2,2,2,2,  16,16,16,16,16, 4,4],#M2
 [16,2,2,2,2,2,   16,4,4,4,4,4,       16,2,2,2,2,   16,16,16,16,16,  16,16],#M3
 [16,2,2,2,2,2,  16,16,16,16,16,16,  16,2,2,2,2,   16,4,4,4,4,  16,16],#M4
 [16,2,2,2,2,2,   16,16,16,16,16,16,  2,2,2,2,2,    16,16,16,16,16, 2,16],#M5
 [2,2,2,2,2,2,   16,16,16,16,16,16,  2,2,2,2,2,    16,16,16,16,16, 2,16],#M6
 [8,4,4,4,2,2,    8,4,4,4,4,4,      4,4,4,4,4,    4,4,4,4,4, 4,4],#M7
 [8,2,2,2,2,2,    8,4,4,4,4,4,       4,4,4,4,4,     4,4,4,4,4, 4,4],#M8
 [8,4,4,4,2,2,     8,4,4,4,4,4,    4,2,2,2,2,    4,4,4,4,4, 4,4],#M9
 [4,2,2,2,2,2,   8,4,4,4,4,4,   4,4,4,4,4,   4,4,4,4,4, 4,4],#M10
 [8,4,4,4,4,4,  8,4,4,4,4,4,  2,2,2,2,2,    4,4,4,4,4, 4,4],#M11
 [8,4,4,4,4,4,   8,4,4,4,4,4,    4,2,2,2,2,   4,4,4,4,4, 2,4],#M12
 [8,2,2,2,2,2,    8,4,4,4,4,4,   2,2,2,2,2,   4,4,4,4,4, 4,4],#M13
 [8,2,2,2,2,2,    8,4,4,4,4,4,    4,2,2,2,2,  4,4,4,4,4, 2,4],#M14
 [4,2,2,2,2,2,    4,4,4,4,4,4,   4,2,2,2,2,   4,4,4,4,4, 2,4],#M15
]


def compute_sparsity_sru(x, n_layers=4):
 print(x)
 if n_layers == 4:
  return x[0] * 0.013 + x[1] * 0.05 + x[2] * 0.15 + x[3] * 0.05 + x[4] * 0.15 + x[5] * 0.05 + x[6] * 0.15 + \
         x[7] * 0.372  +97 * 0.015
 if n_layers == 6:
  return x[0] * 0.01 + x[1] * 0.036 + x[2] * 0.108 + x[3] * 0.036 + x[4] * 0.108 + x[5] * 0.036 + x[6] * 0.108 + \
         x[7] * 0.036 + x[8] * 0.108 + x[9] * 0.036 + x[10] * 0.108+ x[11] * 0.268 + 97 * 0.002


size_4=compute_mem([16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16])*2
size_6=compute_mem_6([16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16])*2
for i in range (len(exp_sru_4),len(exp_sru_4)):

  #run_inference_for_optimization('/usr/local/home/nesrez/kaldi', 'exp/TIMIT_SRU_fbank_dnn_6', exp_sru_4[i],
  #                              delta=[0, 0, 0, 0, 0, 0, 0, 0], n_layers=4, test=False,opt_index=4)
  #run_inference_for_optimization('/usr/local/home/nesrez/kaldi', 'exp/TIMIT_SRU_fbank_dnn_6', exp_sru_4[i],
   #                             delta=[0, 0, 0, 0, 0, 0, 0, 0], n_layers=4, test=True)

  #run_inference_for_optimization('/usr/local/home/nesrez/kaldi', 'exp/TIMIT_SRU_fbank_dnn_6jj',exp_sru_4[i],delta=[0,0,0,0,0,0,0,0],n_layers=4,test=False,opt_index=5)

   # size=compute_mem(exp_sru_4[i])
   # print(size)
   # print(100-size/size_4*100)
 #  w, s = run_inference_for_optimization('/usr/local/home/nesrez/kaldi', 'exp/TIMIT_SRU_fbank_dnn_6', exp_sru_4[i],
                              #          delta=[0, 0, 0, 0, 0, 0, 0, 0], n_layers=4, test=False)

   #print(compute_sparsity_sru((list(map(float, s.split(",")))), 4))
   w,s=run_inference_for_optimization('/usr/local/home/nesrez/kaldi', 'exp/TIMIT_SRU_fbank_dnn_l6', exp_sru_6[i], delta=[0,0,0,0,0,0,0,0,0,0,0,0],n_layers=6, test=False,opt_index=4)

   #print(compute_sparsity_sru((list(map(float, s.split(",")))),6))
   run_inference_for_optimization('/usr/local/home/nesrez/kaldi', 'exp/TIMIT_SRU_fbank_dnn_l6', exp_sru_6[i],  delta=[0,0,0,0,0,0,0,0,0,0,0,0],n_layers=6,test=True)
   # size=compute_mem_6(exp_sru_6[i])
   # print(size)
   # print(100-size/size_6*100)